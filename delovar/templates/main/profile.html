{% extends 'base.html' %}

{% block title %}
  –ü—Ä–æ—Ñ–∏–ª—å
{% endblock %}

{% block head %}<style>
  #main {
    overflow-y: scroll;
    height: calc(100vh - 67px - 73px);
  }
  #document_preview {
    width: 100%;
    height: calc(100vh - 67px - 73px - 16px - 80px - 34px - 65px);
    padding-right: 3rem;
  }
  @media screen and (min-width:768px) {
    #main {
      height: calc(100vh - 67px - 49px);
    }
    #document_preview {
      height: calc(100vw - 67px - 73px - 16px - 80px - 34px - 65px);
      padding-right: 5rem;
    }
  }
  @media screen and (min-width:992px) {
    #main {
      height: calc(100vh - 73px - 83px);
    }
    #document_preview {
      padding-right: 0rem;
    }
  }
</style>{% endblock %}

{% block body %}
<div id="main" class="text-white color-mid px-0">
  <div class="row row-cols-1 row-cols-lg-3 justify-content-between pt-3 mx-0">
    <div class="col mb-3 px-3">
      <div class="mb-3">
        <h3>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞</h3>
        <select id="document_preview_select" class="form-select" aria-label="Default select example">
          {% for document in documents %}
            <option value="{{ forloop.counter }}" data-bs-url="{{ document.url }}">{{ document.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <h3>–ü—Ä–µ–≤—å—é –¥–æ–∫—É–º–µ–Ω—Ç–∞</h3>
        <iframe id="document_preview" frameborder="0"></iframe>
      </div>
    </div>
    <div class="col mb-3 px-3">
      <div class="mb-3">
        <h3>–ó–∞–≥—Ä—É–∑–∏—Ç–µ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö</h3>
        <button id="choose-database" class="btn btn-lg btn-primary">–ó–∞–≥—Ä—É–∑–∏—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö</button>
        <input id="database-input" type="file" accept="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" style="display: none;"/>
      </div>
      <div id="database-table-inner">
        <h3>–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö</h3>
      </div>
    </div>
    <div class="col px-3">
      <div class="mb-3">
        <h3>–ù–∞—á–Ω–∏—Ç–µ –ø—Ä–æ—Ü–µ—Å—Å</h3>
        <button class="btn btn-lg btn-primary">–ù–∞—á–∞—Ç—å</button>
      </div>
      <div>
        <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</h3>
      </div>
    </div>
  </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.8.0/jszip.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.8.0/xlsx.js"></script>
<script>
  function update_document_preview(el) {
    let index = el.currentTarget.selectedIndex;
    let option = el.currentTarget.options[index];
    let url = option.getAttribute('data-bs-url');
    let preview = document.getElementById('document_preview');
    preview.src = url;
    localStorage.setItem('document_choice', index);
  }

  $('#document_preview_select')
    .on('change', update_document_preview)
    .trigger('change')

  const excelFileInput = document.getElementById('database-input');

  excelFileInput.addEventListener('change', (event) => {
    const file = event.target.files[0];
    const reader = new FileReader();

    reader.onload = (event) => {
      const data = new Uint8Array(event.target.result);
      const workbook = XLSX.read(data, { type: 'array' });
      const sheetName = workbook.SheetNames[0];
      const worksheet = workbook.Sheets[sheetName];
      const tableData = XLSX.utils.sheet_to_json(worksheet);

      createTable(tableData);
    };

    reader.readAsArrayBuffer(file);
  });

  function getTableSample() {
    return $('<tr>')
      .append($('<th>', { // open modal
        scope: 'row',
        class: 'btn text-white form-control bg-primary',
        click: () => {openUserUpdateModal(id)},
        text: localStorage.getItem('pk-' + id)
      }))
      .append($('<td>', { // phone
        class: 'btn table-cell-button text-decoration-none',
        click: () => {window.location.href = 'tel:+' + id},
        text: 'üìû'
      }))
      .append($('<td>') // firstname
        .append($('<span>', {
          id: 'firstname-' + id
        }))
      )
      .append($('<td>') // lastname
        .append($('<span>', {
          id: 'lastname-' + id
        }))
      )
      .append($('<td>', { // output1
        class: 'btn table-cell-button',
        id: 'output1-' + id,
        click: () => {ajaxToggleUser(id, 'output1')}
      }))
      .append($('<td>', { // dialToOpen
        class: 'btn table-cell-button',
        id: 'dialToOpen-' + id,
        click: () => {ajaxToggleUser(id, 'dialToOpen')}
      }))
      .append($('<td>', { // delete
        class: 'btn table-cell-button text-white bg-danger',
        click: () => {openDeleteConfirmModal(id)},
        text: '-'
      }))
  }

  function createTable(data) {
    const divElement = document.createElement('div');

    divElement.setAttribute('id', 'database-table');

    const tableElement = document.createElement('table');

    for (let i = 0; i < data.length; i++) {
      const rowElement = document.createElement('tr');

      for (const key in data[i]) {
        const cellElement = document.createElement('td');
        cellElement.innerText = data[i][key];
        rowElement.appendChild(cellElement);
      }

      tableElement.appendChild(rowElement);
    }

    divElement.appendChild(tableElement);

    document.getElementById('database-table-inner').appendChild(divElement);
  }

  $('#choose-database').on('click', function() {
    $('#database-input').trigger('click');
  });
</script>
{% endblock %}