{% extends 'base.html' %}

{% block title %}
  Новое Дело
{% endblock %}

{% block body %}<div class="container p-3">
  <h3 class="text-white">Новое Дело</h3>
  <form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    {% for error in form.non_field_errors %}
      <div class="bg-danger p-3 mb-3 text-white rounded-3">
        {{ error }}
      </div>
    {% endfor %}
    {% if error_message %}
      <div class="bg-warning p-3 mb-3 text-white rounded-3">
        {{ error_message }}
      </div>
    {% endif %}
    {% for field in form %}
      {% for error in field.errors %}
        <div class="bg-danger p-3 mb-3 text-white rounded-3">
          <strong>{{ field.label }}</strong>: {{ error }}
        </div>
      {% endfor %}
    {% endfor %}
    {{ form.as_p }}
    <div id="debt_data_container">

    </div>
    <button type="submit" class="btn btn-success">Создать Дело</button>
  </form>
</div>{% endblock %}

{% block scripts %}<script>
  const
    inputDebt = $('#id_debt_statement'),
    debtDataContainer = $('#debt_data_container');

  inputDebt.change(() => {
    let fd = new FormData;
    fd.append('pdf', inputDebt.prop('files')[0])
    $.ajax({
      type: 'POST',
      url: "{% url 'main:get_debt_data' %}",
      headers: {
        'X-CSRFToken': '{{ csrf_token }}'
      },
      data: fd,
      processData: false,
      contentType: false,
      success: (response) => {
        debtDataContainer.html('')
        response.data.forEach(element => {
          debtDataContainer.append(
            $('<div>').append(
              $('<strong>', {
                class: '',
                text: element[0]
              }),
              $('<p>', {
                text: element[1]
              })
            )
          )
        });
        // debtDataContainer.text(response.data);
      }
    });
  })
</script>{% endblock %}
